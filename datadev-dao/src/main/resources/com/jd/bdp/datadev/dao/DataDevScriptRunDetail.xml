<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jd.bdp.datadev.dao.DataDevScriptRunDetailDao">
    <sql id="run_detail_columns">
        id,
        script_file_id as scriptFileId,
        version,
        operator,
        start_time as startTime,
        end_time as endTime,
        status,
        cluster_code as clusterCode,
        market_linux_user as marketLinuxUser,
        queue_code as queueCode,
        account_code as accountCode,
        args,
        process_id as processId,
        creator,
        created,
        type,
        log_count as logCount,
        data_count as dataCount,
        envs,
        response_code as responseCode,
        args_import_type as argsImportType,
        start_shell_path as startShellPath,
        ip,
        script_config_id AS scriptConfigId,
        stop_erp as stopErp,
        git_project_id as gitProjectId,
        git_project_file_path as gitProjectFilePath,
        engine_type as engineType,
        run_type AS runType,
        git_project_dir_path AS gitProjectDirPath,
        dependency_id AS dependencyId,
        debug_flag as debugFlag,
        run_tmp as runTmp,
        run_cluster_code as runClusterCode,
        run_market_linux_user as runMarketLinuxUser
    </sql>

    <select id="findById" resultType="DataDevScriptRunDetail">
        SELECT
        <include refid="run_detail_columns"></include>
        FROM
        script_run_detail
        WHERE id = #{id}
    </select>
    <insert id="insertRunDetail" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO script_run_detail(
        script_file_id,
        version,
        operator,
        start_time,
        end_time,
        status,
        cluster_code,
        market_linux_user,
        queue_code,
        account_code,
        args,
        creator,
        created,
        type,
        log_count,
        data_count,
        envs,
        start_shell_path,
        args_import_type,
        script_config_id,
        git_project_id,
        git_project_file_path,
        engine_type,
        run_type,
        git_project_dir_path,
        dependency_id,
        ip,
        debug_flag,
        run_tmp,
        run_cluster_code,
        run_market_linux_user
        )
        VALUES (
        #{scriptFileId},#{version},#{operator},#{startTime},#{endTime},#{status},#{clusterCode},
        #{marketLinuxUser},#{queueCode},#{accountCode},#{args},#{creator},#{startTime},#{type},#{logCount},#{dataCount},
        #{envs},#{startShellPath},#{argsImportType},#{scriptConfigId},#{gitProjectId},#{gitProjectFilePath},#{engineType},
        #{runType},#{gitProjectDirPath},#{dependencyId},#{ip},#{debugFlag},#{runTmp},#{runClusterCode},#{runMarketLinuxUser}
        )

    </insert>
    <update id="updateRuntailStatus">
        UPDATE script_run_detail
        SET
        <if test="startTime !=null ">
            start_time = #{startTime},
        </if>
        <if test="endTime !=null ">
            end_time = #{endTime},
        </if>
        <if test="processId!=null and processId!=''">
            process_id=#{processId},
        </if>
        <if test="ip!=null and ip!=''">
            ip=#{ip},
        </if>
        <if test="logCount !=null and logCount != ''">
            log_count=#{logCount},
        </if>
        <if test="dataCount !=null and dataCount != ''">
            data_count=#{dataCount},
        </if>
        <if test="responseCode != null and responseCode != ''">
            response_code = #{responseCode},
        </if>
        <if test="stopErp != null and stopErp != ''">
            stop_erp = #{stopErp},
        </if>
        status=#{status}
        WHERE id = #{id}
    </update>
    <select id="list4page" resultType="DataDevScriptRunDetail">
        SELECT
        <include refid="run_detail_columns"></include>
        FROM script_run_detail
        WHERE script_file_id = #{scriptFileId}
        <if test="startTimeFrom !=null ">
            AND start_time >= #{startTimeFrom}
        </if>
        <if test="startTimeTo !=null ">
            AND start_time &lt;= #{startTimeTo}
        </if>
        <if test="endTimeFrom !=null ">
            AND end_time >= #{endTimeFrom}
        </if>
        <if test="endTimeTo !=null ">
            AND end_time &lt;= #{endTimeTo}
        </if>
        <if test="statusList != null ">
            AND
            <foreach collection="statusList" item="item" open="(" close=")" separator="or">
                status = #{item}
            </foreach>
        </if>
        ORDER BY id desc limit #{start},#{limit}
    </select>
    <select id="count4page" resultType="Long">
        SELECT count(*)
        FROM script_run_detail
        WHERE script_file_id = #{scriptFileId}
        <if test="startTimeFrom !=null ">
            AND start_time >= #{startTimeFrom}
        </if>
        <if test="startTimeTo !=null ">
            AND start_time &lt;= #{startTimeTo}
        </if>
        <if test="endTimeFrom !=null ">
            AND end_time >= #{endTimeFrom}
        </if>
        <if test="endTimeTo !=null ">
            AND end_time &lt;= #{endTimeTo}
        </if>
        <if test="statusList != null ">
            AND
            <foreach collection="statusList" item="item" open="(" close=")" separator="or">
                status = #{item}
            </foreach>
        </if>

    </select>
    <select id="findLastRunDetail" resultType="DataDevScriptRunDetail">
        SELECT
        <include refid="run_detail_columns"></include>
        FROM script_run_detail
        WHERE script_file_id = #{scriptFileId}
        <if test="operator!=null and operator!=''">
            AND operator = #{operator}
        </if>
        ORDER by id DESC limit 1
    </select>

    <update id="updateRunDetailPath">
        UPDATE script_run_detail
        SET git_project_file_path = #{gitNewProjectFilePath}
        WHERE git_project_id = #{gitProjectId} AND git_project_file_path = #{gitProjectFilePath}
    </update>

    <!--<update id="updatePrestoQueryId">-->
        <!--UPDATE script_run_detail-->
        <!--SET presto_query_id = #{prestoQueryId}-->
        <!--WHERE id=#{id}-->
    <!--</update>-->
    <update id="updateRunCode">
        update script_run_detail
        set cluster_code = 'sc',market_linux_user = 'mart_sc',run_cluster_code = #{runClusterCode},run_market_linux_user = #{runLinuxUser}
        where cluster_code = #{clusterCode} and market_linux_user = #{linuxUser}
    </update>


    <select id="listFinishTask" resultType="DataDevScriptRunDetail">
        SELECT
        <include refid="run_detail_columns"></include>
        FROM
        script_run_detail
        WHERE `status` != 2  and log_count > 0 order by id desc limit #{limit}

    </select>

    <select id="runListPage" resultType="DataDevScriptRunDetail">
        SELECT
        runDetail.id,
        runDetail.script_file_id as scriptFileId,
        runDetail.version,
        runDetail.operator,
        runDetail.start_time as startTime,
        runDetail.end_time as endTime,
        runDetail.status,
        runDetail.cluster_code as clusterCode,
        runDetail.market_linux_user as marketLinuxUser,
        runDetail.queue_code as queueCode,
        runDetail.account_code as accountCode,
        runDetail.args,
        runDetail.process_id as processId,
        runDetail.creator,
        runDetail.created,
        runDetail.type,
        runDetail.log_count as logCount,
        runDetail.data_count as dataCount,
        runDetail.envs,
        runDetail.response_code as responseCode,
        runDetail.args_import_type as argsImportType,
        runDetail.start_shell_path as startShellPath,
        runDetail.ip,
        runDetail.script_config_id AS scriptConfigId,
        runDetail.stop_erp as stopErp,
        runDetail.git_project_id as gitProjectId,
        runDetail.git_project_file_path as gitProjectFilePath,
        runDetail.engine_type as engineType,
        runDetail.run_type AS runType,
        runDetail.git_project_dir_path AS gitProjectDirPath,
        runDetail.dependency_id AS dependencyId,
        runDetail.debug_flag as debugFlag,
        runDetail.run_tmp as runTmp,
        runDetail.run_cluster_code as runClusterCode,
        runDetail.run_market_linux_user as runMarketLinuxUser ,
        gitProject.git_project_path as gitProjectPath ,
        scriptConfig.market_id as marketId,
        scriptConfig.queue_id as queueId,
        scriptConfig.account_id as accountId
        FROM script_run_detail as runDetail
        left join git_project as gitProject on gitProject.git_project_id = runDetail.git_project_id
        left join script_config as scriptConfig on scriptConfig.id = runDetail.script_config_id
        WHERE 1 = 1
        <if test="id != null">
            AND runDetail.id = #{id}
        </if>
        <if test="operator != null and operator != ''">
            AND runDetail.operator = #{operator}
        </if>
        <if test="startTimeFrom !=null ">
            AND runDetail.start_time >= #{startTimeFrom}
        </if>
        <if test="startTimeTo !=null ">
            AND runDetail.start_time &lt;= #{startTimeTo}
        </if>
        <if test="endTimeFrom !=null ">
            AND runDetail.end_time >= #{endTimeFrom}
        </if>
        <if test="endTimeTo !=null ">
            AND runDetail.end_time &lt;= #{endTimeTo}
        </if>
        <if test="marketId !=null ">
            AND scriptConfig.market_id = #{marketId}
        </if>
        <if test="statusList != null ">
            AND
            <foreach collection="statusList" item="item" open="(" close=")" separator="or">
                runDetail.status = #{item}
            </foreach>
        </if>

        ORDER BY id desc limit #{start},#{limit}
    </select>
    <select id="runListCount" resultType="Long">
        SELECT count(*)
        FROM script_run_detail
        left join script_config as scriptConfig on scriptConfig.id = script_run_detail.script_config_id
        WHERE 1 = 1
        <if test="id != null">
            AND script_run_detail.id = #{id}
        </if>
        <if test="operator != null and operator != ''">
            AND operator = #{operator}
        </if>
        <if test="startTimeFrom !=null ">
            AND start_time >= #{startTimeFrom}
        </if>
        <if test="startTimeTo !=null ">
            AND start_time &lt;= #{startTimeTo}
        </if>
        <if test="endTimeFrom !=null ">
            AND end_time >= #{endTimeFrom}
        </if>
        <if test="endTimeTo !=null ">
            AND end_time &lt;= #{endTimeTo}
        </if>
        <if test="marketId !=null ">
            AND scriptConfig.market_id = #{marketId}
        </if>
        <if test="statusList != null ">
            AND
            <foreach collection="statusList" item="item" open="(" close=")" separator="or">
                status = #{item}
            </foreach>
        </if>
    </select>


</mapper>
